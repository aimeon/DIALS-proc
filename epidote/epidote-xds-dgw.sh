#!/bin/bash

set -x

# Check script input
if [ "$#" -ne 1 ]; then
    echo "You must supply the location of the data parent directory " \
"(containing Data_2/, Data_3/ and Data_4/) only"
    exit 1
fi
PARENTDIR=$(realpath "$1")

mkdir -p Data_2/
cd Data_2/
cat <<EOF > XDS.INP
MAXIMUM_NUMBER_OF_JOBS=4
MAXIMUM_NUMBER_OF_PROCESSORS=4
NAME_TEMPLATE_OF_DATA_FRAMES= $PARENTDIR/Data_2/SMV/data/0????.img   SMV
DATA_RANGE=           1 519
SPOT_RANGE=           1 519
BACKGROUND_RANGE=     1 519
EXCLUDE_DATA_RANGE=20 20
EXCLUDE_DATA_RANGE=40 40
EXCLUDE_DATA_RANGE=60 60
EXCLUDE_DATA_RANGE=80 80
EXCLUDE_DATA_RANGE=100 100
EXCLUDE_DATA_RANGE=120 120
EXCLUDE_DATA_RANGE=140 140
EXCLUDE_DATA_RANGE=160 160
EXCLUDE_DATA_RANGE=180 180
EXCLUDE_DATA_RANGE=200 200
EXCLUDE_DATA_RANGE=220 220
EXCLUDE_DATA_RANGE=240 240
EXCLUDE_DATA_RANGE=260 260
EXCLUDE_DATA_RANGE=280 280
EXCLUDE_DATA_RANGE=300 300
EXCLUDE_DATA_RANGE=320 320
EXCLUDE_DATA_RANGE=340 340
EXCLUDE_DATA_RANGE=360 360
EXCLUDE_DATA_RANGE=380 380
EXCLUDE_DATA_RANGE=400 400
EXCLUDE_DATA_RANGE=420 420
EXCLUDE_DATA_RANGE=440 440
EXCLUDE_DATA_RANGE=460 460
EXCLUDE_DATA_RANGE=480 480
EXCLUDE_DATA_RANGE=500 500
SPACE_GROUP_NUMBER= 11
UNIT_CELL_CONSTANTS= 9.035  5.795 10.397  90.000 115.659  90.000
FRIEDEL'S_LAW=TRUE
STARTING_ANGLE= -61.2300
STARTING_FRAME= 1
MAX_CELL_AXIS_ERROR=  0.05
MAX_CELL_ANGLE_ERROR= 3.0
TEST_RESOLUTION_RANGE=10. 1.0
NX=516     NY=516
QX=0.0550  QY=0.0550
OVERLOAD= 130000
TRUSTED_REGION= 0.0  1.05
SENSOR_THICKNESS=0.30
AIR=0.0
UNTRUSTED_RECTANGLE= 255 262 0 517
UNTRUSTED_RECTANGLE= 0 517 255 262
VALUE_RANGE_FOR_TRUSTED_DETECTOR_PIXELS= 10 30000
INCLUDE_RESOLUTION_RANGE= 20 0.8
DIRECTION_OF_DETECTOR_X-AXIS= 1 0 0
DIRECTION_OF_DETECTOR_Y-AXIS= 0 1 0
ORGX= 215.45    ORGY= 227.39
DETECTOR_DISTANCE= +439.48
OSCILLATION_RANGE= 0.2320
ROTATION_AXIS= -0.6204 0.7843 0.0000
X-RAY_WAVELENGTH= 0.0251
INCIDENT_BEAM_DIRECTION= 0 0 1
REFINE(IDXREF)=    BEAM AXIS ORIENTATION CELL !POSITION
REFINE(INTEGRATE)= !POSITION BEAM AXIS !ORIENTATION CELL
REFINE(CORRECT)=   BEAM AXIS ORIENTATION CELL !POSITION
MINIMUM_FRACTION_OF_INDEXED_SPOTS= 0.25
EOF
xds
cd ..

mkdir -p Data_3
cd Data_3/
cat <<EOF > XDS.INP
MAXIMUM_NUMBER_OF_JOBS=4
MAXIMUM_NUMBER_OF_PROCESSORS=4
NAME_TEMPLATE_OF_DATA_FRAMES= $PARENTDIR/Data_3/SMV/data/0????.img   SMV
DATA_RANGE=           1 530
SPOT_RANGE=           1 530
BACKGROUND_RANGE=     1 530
EXCLUDE_DATA_RANGE=20 20
EXCLUDE_DATA_RANGE=40 40
EXCLUDE_DATA_RANGE=60 60
EXCLUDE_DATA_RANGE=80 80
EXCLUDE_DATA_RANGE=100 100
EXCLUDE_DATA_RANGE=120 120
EXCLUDE_DATA_RANGE=140 140
EXCLUDE_DATA_RANGE=160 160
EXCLUDE_DATA_RANGE=180 180
EXCLUDE_DATA_RANGE=200 200
EXCLUDE_DATA_RANGE=220 220
EXCLUDE_DATA_RANGE=240 240
EXCLUDE_DATA_RANGE=260 260
EXCLUDE_DATA_RANGE=280 280
EXCLUDE_DATA_RANGE=300 300
EXCLUDE_DATA_RANGE=320 320
EXCLUDE_DATA_RANGE=340 340
EXCLUDE_DATA_RANGE=360 360
EXCLUDE_DATA_RANGE=380 380
EXCLUDE_DATA_RANGE=400 400
EXCLUDE_DATA_RANGE=420 420
EXCLUDE_DATA_RANGE=440 440
EXCLUDE_DATA_RANGE=460 460
EXCLUDE_DATA_RANGE=480 480
EXCLUDE_DATA_RANGE=500 500
EXCLUDE_DATA_RANGE=520 520
SPACE_GROUP_NUMBER= 11
UNIT_CELL_CONSTANTS= 9.035  5.795 10.397  90.000 115.659  90.000
FRIEDEL'S_LAW=TRUE
STARTING_ANGLE= -71.9900
STARTING_FRAME= 1
MAX_CELL_AXIS_ERROR=  0.05
MAX_CELL_ANGLE_ERROR= 3.0
TEST_RESOLUTION_RANGE=10. 1.0
NX=516  NY=516
QX=0.055  QY=0.055
OVERLOAD= 130000
TRUSTED_REGION= 0.0  1.05
SENSOR_THICKNESS=0.30
AIR=0.0
UNTRUSTED_RECTANGLE= 255 262 0 517
UNTRUSTED_RECTANGLE= 0 517 255 262
VALUE_RANGE_FOR_TRUSTED_DETECTOR_PIXELS= 10 30000
INCLUDE_RESOLUTION_RANGE= 20 0.8
DIRECTION_OF_DETECTOR_X-AXIS= 1 0 0
DIRECTION_OF_DETECTOR_Y-AXIS= 0 1 0
ORGX= 241.86    ORGY= 267.21
DETECTOR_DISTANCE= +439.48
OSCILLATION_RANGE= 0.2306
ROTATION_AXIS= -0.6204 0.7843 0.0000
X-RAY_WAVELENGTH= 0.0251
INCIDENT_BEAM_DIRECTION= 0 0 1
REFINE(IDXREF)=    BEAM AXIS ORIENTATION CELL !POSITION
REFINE(INTEGRATE)= !POSITION BEAM AXIS !ORIENTATION CELL
REFINE(CORRECT)=   BEAM AXIS ORIENTATION CELL !POSITION
MINIMUM_FRACTION_OF_INDEXED_SPOTS= 0.25
EOF
xds
cd ..

mkdir -p Data_4
cd Data_4/
cat <<EOF > XDS.INP
MAXIMUM_NUMBER_OF_JOBS=4
MAXIMUM_NUMBER_OF_PROCESSORS=4
NAME_TEMPLATE_OF_DATA_FRAMES= $PARENTDIR/Data_4/SMV/data/0????.img   SMV
DATA_RANGE=           1 554
SPOT_RANGE=           1 554
BACKGROUND_RANGE=     1 554
EXCLUDE_DATA_RANGE=20 20
EXCLUDE_DATA_RANGE=40 40
EXCLUDE_DATA_RANGE=60 60
EXCLUDE_DATA_RANGE=80 80
EXCLUDE_DATA_RANGE=100 100
EXCLUDE_DATA_RANGE=120 120
EXCLUDE_DATA_RANGE=140 140
EXCLUDE_DATA_RANGE=160 160
EXCLUDE_DATA_RANGE=180 180
EXCLUDE_DATA_RANGE=200 200
EXCLUDE_DATA_RANGE=220 220
EXCLUDE_DATA_RANGE=240 240
EXCLUDE_DATA_RANGE=260 260
EXCLUDE_DATA_RANGE=280 280
EXCLUDE_DATA_RANGE=300 300
EXCLUDE_DATA_RANGE=320 320
EXCLUDE_DATA_RANGE=340 340
EXCLUDE_DATA_RANGE=360 360
EXCLUDE_DATA_RANGE=380 380
EXCLUDE_DATA_RANGE=400 400
EXCLUDE_DATA_RANGE=420 420
EXCLUDE_DATA_RANGE=440 440
EXCLUDE_DATA_RANGE=460 460
EXCLUDE_DATA_RANGE=480 480
EXCLUDE_DATA_RANGE=500 500
EXCLUDE_DATA_RANGE=520 520
EXCLUDE_DATA_RANGE=540 540
SPACE_GROUP_NUMBER= 11
UNIT_CELL_CONSTANTS= 9.035  5.795 10.397  90.000 115.659  90.000
FRIEDEL'S_LAW=TRUE
STARTING_ANGLE= -61.5800
STARTING_FRAME= 1
MAX_CELL_AXIS_ERROR=  0.05
MAX_CELL_ANGLE_ERROR= 3.0
TEST_RESOLUTION_RANGE=10. 1.0
NX=516     NY=516
QX=0.0550  QY=0.0550
OVERLOAD= 130000
TRUSTED_REGION= 0.0  1.05
SENSOR_THICKNESS=0.30
AIR=0.0
UNTRUSTED_RECTANGLE= 255 262 0 517
UNTRUSTED_RECTANGLE= 0 517 255 262
VALUE_RANGE_FOR_TRUSTED_DETECTOR_PIXELS= 10 30000
INCLUDE_RESOLUTION_RANGE= 20 0.8
DIRECTION_OF_DETECTOR_X-AXIS= 1 0 0
DIRECTION_OF_DETECTOR_Y-AXIS= 0 1 0
ORGX= 213.93    ORGY= 228.12
DETECTOR_DISTANCE= +439.48
OSCILLATION_RANGE= 0.2314
ROTATION_AXIS= -0.6204 0.7843 0.0000
X-RAY_WAVELENGTH= 0.0251
INCIDENT_BEAM_DIRECTION= 0 0 1
REFINE(IDXREF)=    BEAM AXIS ORIENTATION CELL !POSITION
REFINE(INTEGRATE)= !POSITION BEAM AXIS !ORIENTATION CELL
REFINE(CORRECT)=   BEAM AXIS ORIENTATION CELL !POSITION
MINIMUM_FRACTION_OF_INDEXED_SPOTS= 0.25
EOF
xds
cd ..

mkdir -p solve
cd solve/
cat <<EOF > XSCALE.INP
OUTPUT_FILE=temp.ahkl
INPUT_FILE=../Data_2/XDS_ASCII.HKL
INPUT_FILE=../Data_3/XDS_ASCII.HKL
INPUT_FILE=../Data_4/XDS_ASCII.HKL
EOF
xscale

cat <<EOF > XDSCONV.INP
INPUT_FILE=temp.ahkl
OUTPUT_FILE=shelx.hkl  SHELX
FRIEDEL'S_LAW=FALSE
EOF
xdsconv

cat <<+ > shelx.ins
TITL P2/m
CELL 0.0251  9.035  5.795 10.397  90.000 115.659  90.000
ZERR 1.00    0.000  0.000  0.000   0.000   0.000   0.000
LATT 1
SYMM -X,Y,-Z
SFAC SI  2.1293 57.7748  2.5333 16.4756         =
         0.8349  2.8796  0.3216  0.3860  0.0000 =
         0.0000  0.0000  0.0000  1.1100 28.0860
SFAC AL  2.2756 72.3220  2.4280 19.7729         =
         0.8578  3.0799  0.3166  0.4076  0.0000 =
         0.0000  0.0000  0.0000  1.1800 26.9815
SFAC CA  4.4696 99.5228  2.9708 22.6958         =
         1.9696  4.1954  0.4818  0.4165  0.0000 =
         0.0000  0.0000  0.0000  1.4000 40.0800
SFAC FE  2.5440 64.4244  2.3434 14.8806         =
         1.7588  2.8539  0.5062  0.3502  0.0000 =
         0.0000  0.0000  0.0000  1.1700 55.8470
SFAC O   0.4548 23.7803  0.9173  7.6220         =
         0.4719  2.1440  0.1384  0.2959  0.0000 =
         0.0000  0.0000  0.0000  0.7300 15.9990
SFAC H   0.3754 15.4946  0.1408  4.1261         =
         0.0216  0.0246 -0.1012 46.8840  0.0000 =
         0.0000  0.0000  0.0000  0.3200  1.0080
UNIT 3 2 2 1 10 1
TREF 5000
HKLF 4
END
+

shelxt shelx -s"P2(1)_m"
cd ..
