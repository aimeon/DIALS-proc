#!/bin/bash

set -x

# Check script input
if [ "$#" -ne 1 ]; then
    echo "You must supply the location of the data parent directory " \
"(containing Data{1..4}/ only"
    exit 1
fi
PARENTDIR=$(realpath "$1")

mkdir -p Data1
cd Data1
cat <<EOF > XDS.INP
MAXIMUM_NUMBER_OF_JOBS=4
MAXIMUM_NUMBER_OF_PROCESSORS=4
NAME_TEMPLATE_OF_DATA_FRAMES= $PARENTDIR/Data1/SMV/data/0????.img   SMV
DATA_RANGE=           1 513
SPOT_RANGE=           1 513
BACKGROUND_RANGE=     1 513
EXCLUDE_DATA_RANGE=20 20
EXCLUDE_DATA_RANGE=40 40
EXCLUDE_DATA_RANGE=60 60
EXCLUDE_DATA_RANGE=80 80
EXCLUDE_DATA_RANGE=100 100
EXCLUDE_DATA_RANGE=120 120
EXCLUDE_DATA_RANGE=140 140
EXCLUDE_DATA_RANGE=160 160
EXCLUDE_DATA_RANGE=180 180
EXCLUDE_DATA_RANGE=200 200
EXCLUDE_DATA_RANGE=220 220
EXCLUDE_DATA_RANGE=240 240
EXCLUDE_DATA_RANGE=260 260
EXCLUDE_DATA_RANGE=280 280
EXCLUDE_DATA_RANGE=300 300
EXCLUDE_DATA_RANGE=320 320
EXCLUDE_DATA_RANGE=340 340
EXCLUDE_DATA_RANGE=360 360
EXCLUDE_DATA_RANGE=380 380
EXCLUDE_DATA_RANGE=400 400
EXCLUDE_DATA_RANGE=420 420
EXCLUDE_DATA_RANGE=440 440
EXCLUDE_DATA_RANGE=460 460
EXCLUDE_DATA_RANGE=480 480
EXCLUDE_DATA_RANGE=500 500
SPACE_GROUP_NUMBER= 22
UNIT_CELL_CONSTANTS=   6.8   18.8   19.1  89.7  90.1  90.0
FRIEDEL'S_LAW=TRUE
STARTING_ANGLE= -48.3500
STARTING_FRAME= 1
MAX_CELL_AXIS_ERROR=  0.05
MAX_CELL_ANGLE_ERROR= 3.0
TEST_RESOLUTION_RANGE=10. 1.0
NX=516     NY=516
QX=0.0550  QY=0.0550
OVERLOAD= 130000
TRUSTED_REGION= 0.0  1.41
SENSOR_THICKNESS=0.30
AIR=0.0
UNTRUSTED_RECTANGLE= 255 262 0 517
UNTRUSTED_RECTANGLE= 0 517 255 262
VALUE_RANGE_FOR_TRUSTED_DETECTOR_PIXELS= 10 30000
INCLUDE_RESOLUTION_RANGE= 20 0.656
DIRECTION_OF_DETECTOR_X-AXIS= 1 0 0
DIRECTION_OF_DETECTOR_Y-AXIS= 0 1 0
ORGX= 298.49    ORGY= 214.64
DETECTOR_DISTANCE= +439.48
OSCILLATION_RANGE= 0.2318
ROTATION_AXIS= -0.6204 0.7843 0.0000
X-RAY_WAVELENGTH= 0.0251
INCIDENT_BEAM_DIRECTION= 0 0 1
REFINE(IDXREF)=    BEAM AXIS ORIENTATION CELL !POSITION
REFINE(INTEGRATE)= !POSITION BEAM AXIS !ORIENTATION CELL
REFINE(CORRECT)=   BEAM AXIS ORIENTATION CELL !POSITION
MINIMUM_FRACTION_OF_INDEXED_SPOTS= 0.25
EOF
xds
cd ..

mkdir -p Data2
cd Data2
cat <<EOF > XDS.INP
MAXIMUM_NUMBER_OF_JOBS=4
MAXIMUM_NUMBER_OF_PROCESSORS=4
NAME_TEMPLATE_OF_DATA_FRAMES= $PARENTDIR/Data2/SMV/data/0????.img   SMV
DATA_RANGE=           1 522
SPOT_RANGE=           1 522
BACKGROUND_RANGE=     1 522
EXCLUDE_DATA_RANGE=20 20
EXCLUDE_DATA_RANGE=40 40
EXCLUDE_DATA_RANGE=60 60
EXCLUDE_DATA_RANGE=80 80
EXCLUDE_DATA_RANGE=100 100
EXCLUDE_DATA_RANGE=120 120
EXCLUDE_DATA_RANGE=140 140
EXCLUDE_DATA_RANGE=160 160
EXCLUDE_DATA_RANGE=180 180
EXCLUDE_DATA_RANGE=200 200
EXCLUDE_DATA_RANGE=220 220
EXCLUDE_DATA_RANGE=240 240
EXCLUDE_DATA_RANGE=260 260
EXCLUDE_DATA_RANGE=280 280
EXCLUDE_DATA_RANGE=300 300
EXCLUDE_DATA_RANGE=320 320
EXCLUDE_DATA_RANGE=340 340
EXCLUDE_DATA_RANGE=360 360
EXCLUDE_DATA_RANGE=380 380
EXCLUDE_DATA_RANGE=400 400
EXCLUDE_DATA_RANGE=420 420
EXCLUDE_DATA_RANGE=440 440
EXCLUDE_DATA_RANGE=460 460
EXCLUDE_DATA_RANGE=480 480
EXCLUDE_DATA_RANGE=500 500
EXCLUDE_DATA_RANGE=520 520
SPACE_GROUP_NUMBER= 22
UNIT_CELL_CONSTANTS=   6.8   18.8   19.1  89.7  90.1  90.0
FRIEDEL'S_LAW=TRUE
STARTING_ANGLE= -53.2
STARTING_FRAME= 1
MAX_CELL_AXIS_ERROR=  0.05
MAX_CELL_ANGLE_ERROR= 3.0
TEST_RESOLUTION_RANGE=10. 1.0
NX=516     NY=516
QX=0.0550  QY=0.0550
OVERLOAD= 130000
TRUSTED_REGION= 0.0  1.41
SENSOR_THICKNESS=0.30
AIR=0.0
UNTRUSTED_RECTANGLE= 255 262 0 517
UNTRUSTED_RECTANGLE= 0 517 255 262
VALUE_RANGE_FOR_TRUSTED_DETECTOR_PIXELS= 10 30000
INCLUDE_RESOLUTION_RANGE= 20 0.656
DIRECTION_OF_DETECTOR_X-AXIS= 1 0 0
DIRECTION_OF_DETECTOR_Y-AXIS= 0 1 0
ORGX= 299.12    ORGY= 208.50
DETECTOR_DISTANCE= +439.48
OSCILLATION_RANGE= 0.2318
ROTATION_AXIS= -0.6204 0.7843 0.0000
X-RAY_WAVELENGTH= 0.0251
INCIDENT_BEAM_DIRECTION= 0 0 1
REFINE(IDXREF)=    BEAM AXIS ORIENTATION CELL !POSITION
REFINE(INTEGRATE)= !POSITION BEAM AXIS !ORIENTATION CELL
REFINE(CORRECT)=   BEAM AXIS ORIENTATION CELL !POSITION
MINIMUM_FRACTION_OF_INDEXED_SPOTS= 0.25
EOF
xds
cd ..

mkdir -p Data3
cd Data3
cat <<EOF > XDS.INP
MAXIMUM_NUMBER_OF_JOBS=4
MAXIMUM_NUMBER_OF_PROCESSORS=4
NAME_TEMPLATE_OF_DATA_FRAMES= $PARENTDIR/Data3/SMV/data/0????.img   SMV
DATA_RANGE=           1 391
SPOT_RANGE=           1 391
BACKGROUND_RANGE=     1 391
EXCLUDE_DATA_RANGE=20 20
EXCLUDE_DATA_RANGE=40 40
EXCLUDE_DATA_RANGE=60 60
EXCLUDE_DATA_RANGE=80 80
EXCLUDE_DATA_RANGE=100 100
EXCLUDE_DATA_RANGE=120 120
EXCLUDE_DATA_RANGE=140 140
EXCLUDE_DATA_RANGE=160 160
EXCLUDE_DATA_RANGE=180 180
EXCLUDE_DATA_RANGE=200 200
EXCLUDE_DATA_RANGE=220 220
EXCLUDE_DATA_RANGE=240 240
EXCLUDE_DATA_RANGE=260 260
EXCLUDE_DATA_RANGE=280 280
EXCLUDE_DATA_RANGE=300 300
EXCLUDE_DATA_RANGE=320 320
EXCLUDE_DATA_RANGE=340 340
EXCLUDE_DATA_RANGE=360 360
EXCLUDE_DATA_RANGE=380 380
SPACE_GROUP_NUMBER= 22
UNIT_CELL_CONSTANTS=   6.6   18.4   18.7  89.8  90.3  90.2
FRIEDEL'S_LAW=TRUE
STARTING_ANGLE= -53.3500
STARTING_FRAME= 1
MAX_CELL_AXIS_ERROR=  0.05
MAX_CELL_ANGLE_ERROR= 3.0
TEST_RESOLUTION_RANGE=10. 1.0
NX=516     NY=516
QX=0.0550  QY=0.0550
OVERLOAD= 130000
TRUSTED_REGION= 0.0  1.41
SENSOR_THICKNESS=0.30
AIR=0.0
UNTRUSTED_RECTANGLE= 255 262 0 517
UNTRUSTED_RECTANGLE= 0 517 255 262
VALUE_RANGE_FOR_TRUSTED_DETECTOR_PIXELS= 10 30000
INCLUDE_RESOLUTION_RANGE= 20 0.632
DIRECTION_OF_DETECTOR_X-AXIS= 1 0 0
DIRECTION_OF_DETECTOR_Y-AXIS= 0 1 0
ORGX= 293.86    ORGY= 204.03
DETECTOR_DISTANCE= +439.48
OSCILLATION_RANGE= 0.2308
ROTATION_AXIS= -0.6204 0.7843 0.0000
X-RAY_WAVELENGTH= 0.0251
INCIDENT_BEAM_DIRECTION= 0 0 1
REFINE(IDXREF)=    BEAM AXIS ORIENTATION CELL !POSITION
REFINE(INTEGRATE)= !POSITION BEAM AXIS !ORIENTATION CELL
REFINE(CORRECT)=   BEAM AXIS ORIENTATION CELL !POSITION
MINIMUM_FRACTION_OF_INDEXED_SPOTS= 0.25
EOF
xds
cd ..

mkdir -p Data4
cd Data4
cat <<EOF > XDS.INP
MAXIMUM_NUMBER_OF_JOBS=4
MAXIMUM_NUMBER_OF_PROCESSORS=4
NAME_TEMPLATE_OF_DATA_FRAMES= ../../Data4/SMV/data/0????.img   SMV
DATA_RANGE=           1 425
SPOT_RANGE=           1 425
BACKGROUND_RANGE=     1 425
EXCLUDE_DATA_RANGE=20 20
EXCLUDE_DATA_RANGE=40 40
EXCLUDE_DATA_RANGE=60 60
EXCLUDE_DATA_RANGE=80 80
EXCLUDE_DATA_RANGE=100 100
EXCLUDE_DATA_RANGE=120 120
EXCLUDE_DATA_RANGE=140 140
EXCLUDE_DATA_RANGE=160 160
EXCLUDE_DATA_RANGE=180 180
EXCLUDE_DATA_RANGE=200 200
EXCLUDE_DATA_RANGE=220 220
EXCLUDE_DATA_RANGE=240 240
EXCLUDE_DATA_RANGE=260 260
EXCLUDE_DATA_RANGE=280 280
EXCLUDE_DATA_RANGE=300 300
EXCLUDE_DATA_RANGE=320 320
EXCLUDE_DATA_RANGE=340 340
EXCLUDE_DATA_RANGE=360 360
EXCLUDE_DATA_RANGE=380 380
EXCLUDE_DATA_RANGE=400 400
EXCLUDE_DATA_RANGE=420 420
SPACE_GROUP_NUMBER= 22
UNIT_CELL_CONSTANTS= 6.8   18.6   19.0  89.9  89.9  90.2
FRIEDEL'S_LAW=TRUE
STARTING_ANGLE= -27.9900
STARTING_FRAME= 1
MAX_CELL_AXIS_ERROR=  0.05
MAX_CELL_ANGLE_ERROR= 3.0
TEST_RESOLUTION_RANGE=10. 1.0
NX=516     NY=516
QX=0.0550  QY=0.0550
OVERLOAD= 130000
TRUSTED_REGION= 0.0  1.41
SENSOR_THICKNESS=0.30
AIR=0.0
UNTRUSTED_RECTANGLE= 255 262 0 517
UNTRUSTED_RECTANGLE= 0 517 255 262
VALUE_RANGE_FOR_TRUSTED_DETECTOR_PIXELS= 10 30000
INCLUDE_RESOLUTION_RANGE= 20 0.6
DIRECTION_OF_DETECTOR_X-AXIS= 1 0 0
DIRECTION_OF_DETECTOR_Y-AXIS= 0 1 0
ORGX= 294.01    ORGY= 207.02
DETECTOR_DISTANCE= +439.48
OSCILLATION_RANGE= 0.2296
ROTATION_AXIS= -0.6204 0.7843 0.0000
X-RAY_WAVELENGTH= 0.0251
INCIDENT_BEAM_DIRECTION= 0 0 1
REFINE(IDXREF)=    BEAM AXIS ORIENTATION CELL !POSITION
REFINE(INTEGRATE)= !POSITION BEAM AXIS !ORIENTATION CELL
REFINE(CORRECT)=   BEAM AXIS ORIENTATION CELL !POSITION
MINIMUM_FRACTION_OF_INDEXED_SPOTS= 0.25
EOF
xds
cd ..

mkdir -p solve
cd solve/
cat <<EOF > XSCALE.INP
OUTPUT_FILE=temp.ahkl
INPUT_FILE=../Data1/XDS_ASCII.HKL
INPUT_FILE=../Data2/XDS_ASCII.HKL
INPUT_FILE=../Data3/XDS_ASCII.HKL
INPUT_FILE=../Data4/XDS_ASCII.HKL
EOF
xscale

cat <<EOF > XDSCONV.INP
INPUT_FILE=temp.ahkl
OUTPUT_FILE=xds.hkl  SHELX
FRIEDEL'S_LAW=FALSE
EOF
xdsconv

cat <<+ > xds.ins
TITL F222
CELL 0.0251  6.770 18.890 19.040  90.000  90.000  90.000
ZERR 1.00    0.000  0.000  0.000   0.000   0.000   0.000
LATT -4
SYMM X,-Y,-Z
SYMM -X,Y,-Z
SYMM -X,-Y,Z
SFAC SI  2.1293 57.7748  2.5333 16.4756         =
         0.8349  2.8796  0.3216  0.3860  0.0000 =
         0.0000  0.0000  0.0000  1.1100 28.0860
SFAC AL  2.2756 72.3220  2.4280 19.7729         =
         0.8578  3.0799  0.3166  0.4076  0.0000 =
         0.0000  0.0000  0.0000  1.1800 26.9815
SFAC NA  2.2406 108.0039  1.3326 24.5047         =
         0.9070  3.3914  0.2863  0.4346  0.0000 =
         0.0000  0.0000  0.0000  1.4000 22.9900
SFAC O   0.4548 23.7803  0.9173  7.6220         =
         0.4719  2.1440  0.1384  0.2959  0.0000 =
         0.0000  0.0000  0.0000  0.7300 15.9990
SFAC H   0.3754 15.4946  0.1408  4.1261         =
         0.0216  0.0246 -0.1012 46.8840  0.0000 =
         0.0000  0.0000  0.0000  0.3200  1.0080
UNIT 2 1 1 6 2
TREF 5000
HKLF 4
END
+
shelxt xds > shelxt.log
cd ..
